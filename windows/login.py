# -*- coding: utf-8 -*-
# """
# /***************************************************************************
#  Login
#                                  A QGIS plugin
#  This window can be used to login to SenseHawk platform.
#  Generated by Plugin Builder: http://g-sherman.github.io/Qgis-Plugin-Builder/
#                              -------------------
#         begin                : 2022-08-25
#         git sha              : $Format:%H$
#         copyright            : (C) 2022 by SenseHawk
#         email                : kiranh@sensehawk.com
#  ***************************************************************************/
#
# /***************************************************************************
#  *                                                                         *
#  *   This program is free software; you can redistribute it and/or modify  *
#  *   it under the terms of the GNU General Public License as published by  *
#  *   the Free Software Foundation; either version 2 of the License, or     *
#  *   (at your option) any later version.                                   *
#  *                                                                         *
#  ***************************************************************************/
# """

from ..sensehawk_apis.core_apis import core_login
from ..windows.load import LoadWindow
from ..constants import STORAGE_PRIVATE_KEY

from qgis.PyQt import QtWidgets, uic
from qgis.core import QgsMessageLog, Qgis
from qgis.PyQt.QtCore import Qt

import os

LOGIN_UI, _ = uic.loadUiType(os.path.join(os.path.dirname(__file__), 'login.ui'))


class LoginWindow(QtWidgets.QDockWidget, LOGIN_UI):

    def __init__(self, iface):
        """Constructor."""
        super(LoginWindow, self).__init__()
        self.setupUi(self)
        self.loginButton.clicked.connect(self.login)
        self.user_name = None
        self.user_password = None
        self.core_token = None
        self.iface = iface
        # Add to the left docking area by default
        self.iface.addDockWidget(Qt.LeftDockWidgetArea, self)
        self.load_window = None

    def logger(self, message, level=Qgis.Info):
        QgsMessageLog.logMessage(message, 'SenseHawk QC', level=level)

    def login(self):
        # self.user_name = self.userName.text()
        # self.user_password = self.userPassword.text()
        self.user_name = "kiranh@sensehawk.com"
        self.user_password = "%Fortress123&sens"
        self.logger('Logging in SenseHawk user {}...'.format(self.user_name))
        if not self.user_name or not self.user_password:
            self.logger('Username or Password empty...', level=Qgis.Warning)
            return None
        self.core_token = core_login(self.user_name, self.user_password)
        if self.core_token:
            self.logger("Successfully logged in...")
            self.show_load_window()
        else:
            self.logger("incorrect username or password...", level=Qgis.Warning)

    def show_load_window(self):
        # Initialize load save window (next window post login)
        self.load_window = LoadWindow(self.core_token, self.iface)
        self.load_window.show()
        self.hide()
